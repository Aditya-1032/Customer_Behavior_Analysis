use customer_behavior;

-- -Q1. What is the total revenue generated by male vs. female customers?
SELECT gender, SUM(purchase_amount) as revenue
FROM customer 
GROUP BY gender; 

-- Which customer used a discount but still spent more than the average purchase amount
SELECT customer_id, purchase_amount
FROM customer 
WHERE discount_applied = 'Yes'
AND purchase_amount >= (SELECT AVG(purchase_amount)
FROM customer);

-- which are the top 5 products with the highest average review rating
SELECT item_purchased, round(avg(review_rating),2)
FROM customer 
GROUP BY item_purchased
ORDER BY round(avg(review_rating),2) DESC
limit 5;

-- Compare the average purchase amount between standard and express shopping

SELECT shipping_type, Round(AVG(purchase_amount),2)
FROM customer 
WHERE shipping_type = 'Express' OR shipping_type = 'Standard'
GROUP BY shipping_type;

/* Do subscribed customers spend more? Compare average spend and 
total revenue between subscribers and non-subscribers.*/

select 
	subscription_status, 
    count(customer_id) as total_customer,
    ROUND(AVG(purchase_amount),2) as avg_spend,
    SUM(purchase_amount) as revenue
FROM customer 
GROUP BY subscription_status
ORDER BY revenue, avg_spend desc;

-- which 5 products have the highest percentage of purchases with discount applied.
SELECT  
	item_purchased, 
    ROUND(100*SUM(CASE WHEN discount_applied = 'Yes' THEN 1 ELSE 0 END )/COUNT(*),2) as purchase_percentage
from customer
GROUP BY item_purchased
ORDER BY purchase_percentage DESC
LIMIT 5;

/*
Segment customers into New, Returning, and Loyal based on their total 
number of previous purchases, and show the count of each segment. 
*/
SELECT customer_segment, count(*) as Number_of_cust
FROM 
(SELECT 
    CASE WHEN previous_purchases = 1 THEN 'New'
	WHEN previous_purchases BETWEEN 2 AND 10 THEN 'Returning'
    ELSE 'Loyal'
END as customer_segment
FROM customer) t
GROUP BY customer_segment;

-- What are the top 3 most purchasded products within each category?

SELECT 
	rn as 'rank' ,
	category, 
    item_purchased,
    total_item_purchased
FROM 
(SELECT 
	category, 
    item_purchased,
    COUNT(item_purchased) as total_item_purchased,
    ROW_NUMBER() OVER(PARTITION BY category ORDER BY COUNT(item_purchased) DESC) as rn
FROM customer
GROUP BY category, item_purchased
ORDER BY category) t
WHERE rn <= 3;

-- Are customers who are repeat buyers (more than 5 previous purchases) also likely to subscribe?
SELECT 
	subscription_status, 
    COUNT(customer_id) AS repeat_buyers
FROM customer 
WHERE previous_purchases > 5
GROUP BY subscription_status;

-- What is the revenue contribution of each age group? 
SELECT age_group, SUM(purchase_amount) as revenue_contribution
FROM customer 
GROUP BY age_group
ORDER BY revenue_contribution DESC;
ORDER BY revenue_contribution DESC;
ORDER BY revenue_contribution DESC;
    